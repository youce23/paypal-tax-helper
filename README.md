# paypal-tax-helper

PayPal で受け取った USD の報酬を JPY で引き出した履歴から、確定申告に必要な情報を自動計算するツールです。

---

## ✅ 機能概要

USD の入金から JPY の出金までの流れを分析し、以下の 3 項目を計算します。

### 1. 入金額（JPY 換算）

- 入金日の TTM を使用して USD を JPY に換算
  - TTM: 金融機関が日毎に決める為替レート
- 「雑所得」として確定申告時に使用

### 2. 為替差益（雑所得）

- USD 入金時と出金時の TTM の差に基づき、評価額の差分（為替差益）を算出
- これも「雑所得」として扱う

### 3. スプレッド（経費）

- USD 評価額（TTM 換算）と実際の JPY 出金額との差をスプレッド（手数料）とみなす
- 経費（支払手数料）として計上可能

---

## ⚠ 注意

- USD の出金は、必ず残高分をまとめて処理されている前提
- 各計算結果は、小数点以下の丸め処理を行わない
  - 外部で期間累計を求める際に、端数の誤差を生まないため

---

## 📝 入力ファイル

### transactions.csv (UTF-8 with BOM)

#### フォーマット

下記の列を持つ PayPal などの取引データ CSV

| 日付 | 時間 | タイムゾーン | 名前 | タイプ | ステータス | 通貨 | 合計 | 手数料 | 正味 | 残高 | 残高への影響 |
| ---- | ---- | ------------ | ---- | ------ | ---------- | ---- | ---- | ------ | ---- | ---- | ------------ |

#### PayPal からの DL 方法

1. PayPal にログイン
2. 上部メニューから 取引履歴 > 検索欄右の DL マーク > 税務署類 > 取引レポート
   - <https://www.paypal.com/reports/dlog>
3. 取引タイプ: 対象残高, 日付範囲: 任意, 形式: CSV でレポートを作成
4. しばらく待つと、下のリストからダウンロードできるので、上記の名前で保存する
   - 文字コードは自動的に UTF-8 with BOM になる

### ttm_rates.csv (UTF-8 with BOM)

#### フォーマット

日付ごとの TTM（仲値）レート

```csv
日付,TTM
2025-03-14,148.75
2025-03-27,145.00
2025-04-02,144.50
2025-04-09,141.50
```

#### DL 方法

1. 三菱 UFJ リサーチ&コンサルティング の以下のサイトから 年 を指定して「表示」
   - <https://www.murc-kawasesouba.jp/fx/past_3month.php>
2. Excel ファイルが DL されるので、上記形式に変換し、保存する
   - 文字コードを UTF-8 with BOM にすること

---

## 🚀 使用方法

1. 次のファイルを同じディレクトリに置く
   - `transactions.csv`
   - `ttm_rates.csv`
2. スクリプト実行

```bash
python paypal_tax_helper.py
```

3. `output`ディレクトリが作成され、その中に以下のファイルが出力される
   - `transaction_report.csv`
   - `monthly_summary.csv`
   - `yearly_summary.csv`

---

## 📄 出力 CSV（例）

### `transaction_report.csv`

| 種別 | 日付       | USD 金額 | TTM    | JPY 換算額 | 入金時の JPY 換算額の累計 | 為替損益 | スプレッド | 実際の出金額 | 残高（USD） | 残高（JPY 換算） |
| ---- | ---------- | -------- | ------ | ---------- | ------------------------- | -------- | ---------- | ------------ | ----------- | ---------------- |
| 入金 | 2025-03-14 | 0.01     | 148.35 | 1.48       |                           |          |            |              | 0.01        | 1.48             |
| 入金 | 2025-03-27 | 123.45   | 150.58 | 18589.10   |                           |          |            |              | 123.46      | 18590.61         |
| 出金 | 2025-03-27 | 123.46   | 150.58 |            | 18590.58                  | 0.02     | 590.61     | 18000        | 0.0         | 0.0              |
| 入金 | 2025-04-02 | 210.98   | 149.84 | 31613.24   |                           |          |            |              | 210.98      | 31613.24         |
| 出金 | 2025-04-02 | 210.98   | 149.84 |            | 31613.24                  | 0.0      | 613.24     | 31000        | 0.0         | 0.0              |
| 入金 | 2025-04-09 | 156.78   | 145.38 | 22792.68   |                           |          |            |              | 156.78      | 22792.68         |
| 出金 | 2025-04-09 | 156.78   | 145.38 |            | 22792.68                  | 0.0      | 792.68     | 22000        | 0.0         | 0.0              |

- **種別**: 「入金」または「出金」
- **日付**: 取引が行われた日
- **USD 金額**: 取引の USD 金額
- **TTM**: 取引日の TTM レート
- **JPY 換算額**: 入金額を TTM レートで JPY に換算した金額
- **入金時の JPY 換算額の累計**: 出金時点で、各入金時の JPY 換算額を累計した金額
- **為替損益**: 為替変動による損益（雑所得）
- **スプレッド**: 出金手数料（経費）
- **実際の出金額**: 引き落とされた実際の JPY 金額
  - 「JPY 換算額」 + 「入金時の JPY 換算額の累計」 - 「為替損益」に一致する
- **残高（USD）**: 取引後の USD 残高
- **残高（JPY 換算）**: 取引後の USD 残高を TTM レートで JPY に換算した金額

### `monthly_summary.csv`

`transaction_report.csv`を月次で集計したレポート

### `yearly_summary.csv`

`transaction_report.csv`を年次で集計したレポート
